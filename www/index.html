<!DOCTYPE html>
<html>
    <head>
        <title>Capture SGF</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
        <link rel="stylesheet" type="text/css" href="jquery/jquery.mobile-1.0.1.min.css" />
        <link rel="stylesheet" media="screen" href="style.css" type="text/css" />
        <!-- iPad/iPhone specific css below, add after your main css >
         <link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="ipad.css" type="text/css" />		
         <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="iphone.css" type="text/css" />		
         -->
        <script type="text/javascript" charset="utf-8" src="jquery/jquery-1.7.1.min.js"></script>
        <script type="text/javascript" charset="utf-8" src="jquery/jquery.mobile-1.0.1.min.js"></script>
        <script type="text/javascript" charset="utf-8" src="cordova-1.6.0.js"></script>
        <script type="text/javascript" charset="utf-8" src="gocam-plugin.js"></script>
        
        <script type="text/javascript" charset="utf-8">
        
        var pictureSource;   // picture source
        var destinationType; // sets the format of returned value 
        var temp = "582,224,277,117,399,437,45,280";
        var coords = temp.split(","); // board corner coordinates will come from gocam library
        
            // File display and manipulation variables
            var root = null; // File System root variable
            var currentDir = null; // Current DirectoryEntry listed
            var parentDir = null; // Parent of the current directory
            var activeItem = null; // The clicked item
            var activeItemType = null; // d-directory, f-file
            var clipboardItem = null; // file or directory for copy or move
            var clipboardAction = null; // c-copy, m-move
            
        function onBodyLoad() {
            document.addEventListener("deviceready", onDeviceReady, false);
        }
     
        // PhoneGap is ready to be used!
        function onDeviceReady() {
            pictureSource = navigator.camera.PictureSourceType;
            destinationType = navigator.camera.DestinationType;
            getFileSystem();
            clickItemAction();
        }
        
        // Called when a photo is successfully retrieved from camera
        function onPhotoDataSuccess(imageData) {
            document.getElementById('message').innerHTML = imageData;
            
            var canvas = document.getElementById("canvas");
            var ctx = canvas.getContext("2d");
            var sgfCanvas = document.getElementById("preview");

            var image = new Image();
            
            image.onload = function(){
                
                var ratio = 1;
                var maxWidth = 640 / 2;
                var maxHeight = 480 / 2;
                var w = image.width;
                var h = image.height;
                
                if ( w > maxWidth) {
                    ratio = maxWidth / w;
                }
                else if (h > maxHeight) {
                    ratio = maxHeight / h;
                }
                var newWidth = w * ratio;
                var newHeight = h * ratio;
                
                ctx.canvas.width = newWidth;
                ctx.canvas.height = newHeight;
                
                ctx.drawImage(image, 0,0,newWidth,newHeight);
                document.getElementById('message').innerHTML = 'newWidth: ' + newWidth + ' newHeight: ' + newHeight;
                
//                printObject(ctx.drawImage);
                
                // a good point at which to get the corner coordinates from GoCam
                
                goTracer = new GoTracer(image, canvas);
                goTracer.setCorners();
                goTracer.startScan();
                
//                console.log(goTracer.getSGF());
                document.getElementById('sgfoutput').innerHTML = goTracer.getSGF();
                writeFile(goTracer.getSGF());
                
                // draw preview image in SGF page
                var preview = new Preview(sgfCanvas);
                preview.update(goTracer);
            };
            
            image.src = imageData;
            
            
        }
        
        
        
        // Called when a photo is successfully retrieved from Library
        function onPhotoURISuccess(imageURI) {
//          console.log(imageURI);
//            document.getElementById('message').innerHTML = 'imageURI: ' + imageURI;
            
            /* Canvas manipulation */
            var canvas = document.getElementById("canvas");
            var ctx = canvas.getContext("2d");
            var sgfCanvas = document.getElementById("preview");
            
            var image = new Image();
            
            image.onload = function(){
                
                var ratio = 1;
                var maxWidth = 640;
                var maxHeight = 480;
                var w = image.width;
                var h = image.height;
                
                if ( w > maxWidth) {
                    ratio = maxWidth / w;
                    console.log('width greater than ' + maxWidth + ', ratio set to ' + ratio);
                }
                else if (h > maxHeight) {
                    ratio = maxHeight / h;
                    console.log('height greater than ' + maxHeight + ', ratio set to ' + ratio);
                }
                var newWidth = w * ratio;
                var newHeight = h * ratio;
                
                ctx.canvas.width = newWidth;
                ctx.canvas.height = newHeight;
                ctx.drawImage(image, 0,0, newWidth,newHeight);
                console.log('Original Size: ' + w + ' x ' + h + ', Resized in onPhotoURISuccess - newWidth: ' + newWidth + ' newHeight: ' + newHeight);
                document.getElementById('message').innerHTML = 'Resized in onPhotoURISuccess - newWidth: ' + newWidth + ' newHeight: ' + newHeight;
//                printObject(ctx.drawImage);
                                                
                // a good point at which to get the corner coordinates from GoCam
                console.log("About to run GocamPlugin");
                try {
                 GocamPlugin.nativeFunction(["HelloWorld"] ,
                                        
                                        function(result) {console.log("Success : \r\n"+result);      
                                        },
                                        
                                        function(error) {
                                        
                                        console.log("Error : \r\n"+error);      
                                        }
                                        ); 
                } catch (e) {
                    console.log("Exception: "+e);
                }
                
                goTracer = new GoTracer(image, canvas);
                goTracer.setCorners();
                goTracer.startScan();
                //console.log(goTracer.getSGF());
                document.getElementById('sgfoutput').innerHTML = goTracer.getSGF();
                writeFile(goTracer.getSGF());
                
                
                // draw preview image in SGF page
                var preview = new Preview(sgfCanvas);
                preview.update(goTracer);
                
                // save SGF to disk? Send via Email? Open in Browser? Display using eidogo?
//                listFiles();
//                listDir();
            };
            image.src = imageURI;               
        }
        
            /* ------------------- */
            /*  PhoneGap Functions */
            /* ------------------- */
                 
        // A button will call this function

        function capturePhoto() {
            // Take picture using device camera and retrieve image as base64-encoded string
            navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 50 });
        }
        
        function capturePhotoEdit() {
            // Take picture using device camera, allow edit, and retrieve image as base64-encoded string  
            navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 20, allowEdit: true }); 
        }
        
        function getPhoto(source) {
            // Retrieve image file location from specified source
            navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 50, 
                                        destinationType: destinationType.FILE_URI,
                                        sourceType: source });
        }
        
            
            /* --------------------------- */
            /*     Filesystem Functions    */
            /* --------------------------- */
            /* get the root file system */
            function getFileSystem(){
                window.requestFileSystem(LocalFileSystem.PERSISTENT, 0,
                                         function(fileSystem){ // success get file system
                                         root = fileSystem.root;
                                         console.log('getFileSystem - got filesystem for display: ' + root);
                                         listDir(root);
                                         }, function(evt){ // error get file system
                                         console.log("File System Error: "+evt.target.error.code);
                                         }
                                         );
            }
            
            
            /* show the content of a directory */
            function listDir(directoryEntry){
                if( !directoryEntry.isDirectory ) console.log('listDir incorrect type');
//                $.mobile.showPageLoadingMsg(); // show loading message
                
                currentDir = directoryEntry; // set current directory
                directoryEntry.getParent(function(par){ // success get parent
                                         parentDir = par; // set parent directory
                                         if( (parentDir.name == 'sdcard' && currentDir.name != 'sdcard') || parentDir.name != 'sdcard' ) $('#backBtn').show();
                                         }, function(error){ // error get parent
                                         console.log('Get parent error: '+error.code);
                                         });
                
                var directoryReader = directoryEntry.createReader();
                directoryReader.readEntries(function(entries){
                                            var dirContent = $('#dirContent');
                                            dirContent.empty();
                                            
                                            var dirArr = new Array();
                                            var fileArr = new Array();
                                            for(var i=0; i<entries.length; ++i){ // sort entries
                                            var entry = entries[i];
                                            if( entry.isDirectory && entry.name[0] != '.' ) dirArr.push(entry);
                                            else if( entry.isFile && entry.name[0] != '.' ) fileArr.push(entry);
                                            }
                                            
                                            var sortedArr = dirArr.concat(fileArr); // sorted entries
                                            var uiBlock = ['a','b','c','d'];
                                            
                                            for(var i=0; i<sortedArr.length; ++i){ // show directories
                                            var entry = sortedArr[i];
                                            var blockLetter = uiBlock[i%4];
                                            //console.log(entry.name);
                                            if( entry.isDirectory )
                                            dirContent.append('<div class="ui-block-'+blockLetter+'"><div class="folder"><p>'+entry.name+'</p></div></div>');
                                            else if( entry.isFile )
                                            dirContent.append('<div class="ui-block-'+blockLetter+'"><div class="file"><p>'+entry.name+'</p></div></div>');
                                            }
                                            $.mobile.hidePageLoadingMsg(); // hide loading message
                                            }, function(error){
                                            console.log('listDir readEntries error: '+error.code);
                                            });
            }
            
            /* read from file */
            function readFile(fileEntry){
                if( !fileEntry.isFile ) console.log('readFile incorrect type');
//                $.mobile.showPageLoadingMsg(); // show loading message
                
                fileEntry.file(function(file){
                               var reader = new FileReader();
                               reader.onloadend = function(evt) {
                               console.log("Read as data URL");
                               console.log(evt.target.result); // show data from file into console
                               };
                               reader.readAsDataURL(file);
                               
//                               $.mobile.hidePageLoadingMsg(); // hide loading message
                               
                               // dialog with file details
                               $('#file_details').html('<p><strong>Name:</strong> '+file.name+
                                                       '</p><p><strong>Type:</strong> '+file.type+
                                                       '</p><p><strong>Last Modified:</strong> '+new Date(file.lastModifiedDate)+
                                                       '</p><p><strong>Size:</strong> '+file.size);
                               $('#get_file_details').trigger('click');
                               }, function(error){
                               console.log(evt.target.error.code);
                               });
            }
            
            /* open item */
            function openItem(type){
                if( type == 'd' ){
                    listDir(activeItem);
                } else if(type == 'f'){
                    readFile(activeItem);
                }
            }
            
            /* get active item  */
            function getActiveItem(name, type){
                if( type == 'd' && currentDir != null ){
                    currentDir.getDirectory(name, {create:false},
                                            function(dir){ // success find directory
                                            activeItem = dir;
                                            activeItemType = type;
                                            }, 
                                            function(error){ // error find directory
                                            console.log('Unable to find directory: '+error.code);
                                            }
                                            );
                } else if(type == 'f' && currentDir != null){
                    currentDir.getFile(name, {create:false},
                                       function(file){ // success find file
                                       activeItem = file;
                                       activeItemType = type;
                                       },
                                       function(error){ // error find file
                                       console.log('Unable to find file: '+error.code);
                                       }
                                       );
                }
            }
            
            /* get clipboard item for copy or move */
            function getClipboardItem(action){
                if( activeItem != null) {
                    clipboardItem = activeItem;
                    clipboardAction = action;
                }
            }
            
            /* click actions */
            function clickItemAction(){
                var folders = $('.folder');
                var files = $('.file');
//                var backBtn = $('#backBtn');
//                var homeBtn = $('#homeBtn');
                /* menu buttons */
                var menuDialog = $('#menuOptions');
                var openBtn = $('#openBtn');
//                var copyBtn = $('#copyBtn');
//                var moveBtn = $('#moveBtn');
//                var pasteBtn = $('#pasteBtn');
                var deleteBtn = $('#deleteBtn');  
                
                folders.live('tap', function(){
                             var name = $(this).text();
                             getActiveItem(name, 'd');
                             $('#menu').trigger('click'); // menu dialog box
                             });
                
                files.live('tap', function(){
                           var name = $(this).text();
                           getActiveItem(name, 'f');
                           $('#menu').trigger('click'); // menu dialog box
                           // paste button always disabled for files
//                           pasteBtn.button('disable');
//                           pasteBtn.button('refresh');
                           });
                
//                backBtn.click(function(){ // go one level up
//                              if( parentDir != null ) listDir(parentDir);
//                              });
                
//                homeBtn.click(function(){ // go to root
//                              if( root != null ) listDir(root);
//                              });
                
                openBtn.click(function(){
                              menuDialog.dialog('close');
                              openItem(activeItemType);
                             
                              });
                
//                copyBtn.click(function(){
//                              getClipboardItem('c');
//                              menuDialog.dialog('close');
//                              pasteBtn.button('enable');
//                              pasteBtn.button('refresh');
//                              });
//                
//                moveBtn.click(function(){
//                              getClipboardItem('m');
//                              menuDialog.dialog('close');
//                              pasteBtn.button('enable');
//                              pasteBtn.button('refresh');
//                              });
//                
//                pasteBtn.click(function(){
//                               if( clipboardItem != null && clipboardAction != null ){
//                               if(clipboardAction == 'c'){ // copy item
//                               console.log('copy: '+clipboardItem.name + ' to: '+activeItem.name);
//                               clipboardItem.copyTo(activeItem,clipboardItem.name,
//                                                    function(fileCopy){
//                                                    console.log('copy success! '+fileCopy.name);
//                                                    openBtn.trigger('click');
//                                                    }, function(error){
//                                                    console.log('copy error: '+error.code);
//                                                    }
//                                                    );
//                               } else if(clipboardAction == 'm'){ // move item
//                               console.log('move: '+clipboardItem.name + ' to: '+activeItem.name);
//                               clipboardItem.moveTo(activeItem,clipboardItem.name,
//                                                    function(fileCopy){
//                                                    console.log('move success! '+fileCopy.name);
//                                                    openBtn.trigger('click');
//                                                    }, function(error){
//                                                    console.log('move error: '+error.code);
//                                                    }
//                                                    );
//                               }
//                               }
//                               });
                
                deleteBtn.click(function(){
                                if( activeItem != null && activeItemType != null){
                                if(activeItemType=='d'){
                                activeItem.removeRecursively(function(){
                                                             console.log('Directory removed recursively with success');
                                                             menuDialog.dialog('close');
                                                             listDir(currentDir);
                                                             }, function(error){
                                                             console.log('Directory remove recursively error: '+error.code);
                                                             });
                                } else if(activeItemType=='f'){
                                activeItem.remove(function(){
                                                  console.log('File removed with success');
                                                  menuDialog.dialog('close');
                                                  listDir(currentDir);
                                                  }, function(error){
                                                  console.log('File remove error: '+error.code);
                                                  });
                                }
                                }
                                });
            }
            
        
        // used instead of console.log in a few instances.
        function printObject(o) {
            var out = '';
            for (var p in o) {
                out += p + ': ' + o[p] + '\n';
            }
            console.log(out);
        }
        
        function writeFile(SGF) {
            console.log("writeFile begins");
            window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem){
                                     console.log("root filesystem: " + fileSystem.root.name);
                                     fileSystem.root.getFile("SGF.txt", {create: true, exclusive: false}, function(fileEntry){
                                                             console.log("writeFile - fileEntry");
                                                             fileEntry.createWriter(function(writer){
                                                                                    writer.onwriteend = function(evt) {
                                                                                        console.log("writeFile - SGF.txt written");
                                                                                    
                                                                                    }
                                                                                    writer.write(SGF);
                                                                                    }, onFail);
                                                             }, onFail); 
                                     }, onFail); 
        }
        
        function onFail(err) {
            console.log(err)
        }
            
        function savePrefs() {
            console.log("savePrefs begins");
            var $inputs = $('#prefsForm :input');
            // get an associative array of just the values.
            var preferences = {};
            $inputs.each(function() {
                         preferences[this.name] = $(this).val();
                         console.log(this.name + " : " + $(this).val());
                         // need to check SZ is selected? How?
                         });
            console.log(preferences);
            // save prefs to file?
        }
            
//        function listFiles() {
//            console.log("listFiles begins");
//            // request the persistent file system
//            window.requestFileSystem(LocalFileSystem.TEMPORARY, 0, function(fileSystem) {
//                                     console.log(fileSystem.name);
//                                     console.log(fileSystem.root.name);
//                                     console.log("listDir begins");
//                                     var dirEntry = new DirectoryEntry();
//                                     var directoryReader = dirEntry.createReader(fileSystem);
//                                     
//                                     // Get a list of all the entries in the directory
//                                     directoryReader.readEntries(function(entries) {
//                                                                 var i;
//                                                                 for (i=0; i<entries.length; i++) {
//                                                                 console.log(entries[i].name);
//                                                                 }
//                                                                 },function(error) {
//                                                                 alert("Failed to list directory contents: " + error.code);
//                                                                 });
//
//                                     
//                                     }
//                                    , null);
//            }
//        
//            
//        function listDir() {
//            console.log("listDir begins");
//            var directoryReader = dirEntry.createReader();
//            
//            // Get a list of all the entries in the directory
//            directoryReader.readEntries(function(entries) {
//                                        var i;
//                                        for (i=0; i<entries.length; i++) {
//                                        console.log(entries[i].name);
//                                        }
//                                        },function(error) {
//                                        alert("Failed to list directory contents: " + error.code);
//                                        });
//            }
            
            
        /* ------------------- */
        /*  GoTracer Functions */
        /* ------------------- */
        
        
        function GoTracer(img, canvas)
        {
            this.img = img;
            this.canvas = canvas;
            this.ctx = canvas.getContext('2d');
            console.log('GoTracer - this.img.src: ' + this.img.src);
            console.log('GoTracer - this.canvas: ' + this.canvas);
            console.log('GoTracer - this.img.width: ' + this.img.width + ' this.img.height: ' + this.img.height);
        }
        
        GoTracer.prototype.setCorners = function()
        {
            coords = coords.map( function(c) { return 1*c; }); // could dived each corner coordinate by the same amount as display 
            console.log('coords: ' + coords);
            
            this.corners = [
                                new Point(coords[2], coords[3]),
                                new Point(coords[6], coords[7]),
                                new Point(coords[4], coords[5]),
                                new Point(coords[0], coords[1])
                                ];
            console.log('this.corners: ');
            console.log(this.corners);
        }
        
        
        GoTracer.prototype.startScan = function()
        {
            console.log('startScan');
            this.drawImage();
            this.calcRadii();  
            
            var sets = this.getSets(new Rect3D(this.corners));
            
            this.quickPartition(sets, 50);
            this.partition(sets, 3);
            this.assignSets(sets);
        };
        
        GoTracer.prototype.drawImage = function()
        {
            console.log('drawImage');
            var aspectRatio = this.img.width / this.img.height;
            this.canvasWidth = Math.min(this.img.height * aspectRatio, this.img.width);
            this.canvasHeight = Math.min(this.img.width / aspectRatio, this.img.height);
            //console.log(this.img);
            console.log("drawImage - aspectRatio: " + aspectRatio);
            console.log("drawImage - image dimensions: " + this.img.width + "x" + this.img.height);
            console.log("drawImage - canvasWidth x Height: " + this.canvasWidth + "x" + this.canvasHeight);
            console.log("drawImage - this.canvas.width x height: " + this.canvas.width + "x" + this.canvas.height);
            // draw image at scale to fit in canvas width as set in onPhotoURISuccess/onDataSuccess
            this.ctx.drawImage(this.img, 0, 0, this.canvas.width, this.canvas.height);
            // draw image at actual size (to match coordinates)
//            this.ctx.drawImage(this.img, 0, 0);
        };
        
        GoTracer.prototype.calcRadii = function()
        {
            var xs = this.corners.map(function(p) { return p.x });
            var ys = this.corners.map(function(p) { return p.y });
            var xMax = Math.max.apply(Math, xs);
            var xMin = Math.min.apply(Math, xs);
            var yMax = Math.max.apply(Math, ys);
            var yMin = Math.min.apply(Math, ys);
            this.xRadius = (xMax - xMin) / 100;
            this.yRadius = (yMax - yMin) / 100;
        };
        
        GoTracer.prototype.getSets = function(rect)
        {
            var sets = [];
            var measurements = 7;
            for (var x = 0; x < 19; x++)
            {
                for (var y = 0; y < 19; y++)
                {
                    var l = 0, h = 0, count = 0;
                    for (var t = 0; t < measurements; t++)
                    {
                        var phi = t/measurements*2*Math.PI;
                        var c = rect.getPoint(x/18 + 0.012*Math.cos(phi), y/18 + 0.012*Math.sin(phi)).getColor(this.ctx);
                        if (!isNaN(c.l) && !isNaN(c.h))
                        {
                            l += c.l; h += c.h;
                            count++;
                        }
                    }
                    l /= count; h /= count;
                    var l1 = 0, h1 = 0, count = 0;
                    for (var t = 0; t < 4; t++)
                    {
                        var phi = (t+0.5)/2*Math.PI;
                        var x1 = x+0.7*Math.cos(phi);
                        var y1 = y+0.7*Math.sin(phi);
                        if (x1 >= 0 && y1 >= 0 && x1 <= 18 && y1 <= 18)
                        {
                            var c = rect.getPoint(x1/18, y1/18).getColor(this.ctx);
                            if (!isNaN(c.l) && !isNaN(c.h))
                            {
                                l1 += c.l; h1 += c.h;
                                count++;
                            }
                        }
                    }
                    l1 /= count; h1 /= count;
                    
                    sets.push(new PointSet({ 
                                           p: rect.getPoint(x/18, y/18),
                                           x: h - h1 - Math.abs(l - l1) + 64,
                                           y: l,
                                           coord: "[" + String.fromCharCode(y + 97) + String.fromCharCode(x + 97) + "]"
                                           }));
                }
            }
            return sets;
        };
        
        GoTracer.prototype.quickPartition = function(sets, target)
        {
            while (sets.length > target)
            {
                var smallestSet = sets.pop();
                var closestSet = null, closestSetIndex = -1, smallestDistance = Infinity;
                for (var i = 0; i < sets.length; i++)
                {
                    var s = sets[i];
                    var d = smallestSet.getDistanceTo(s);
                    if (d < smallestDistance)
                    {
                        smallestDistance = d;
                        closestSet = s;
                        closestSetIndex = i;
                    }
                }
                if (!closestSet) return
                sets.splice(closestSetIndex, 1);
                closestSet.add(smallestSet);
                for (var i = 0; i < sets.length; i++)
                {
                    if (sets[i].points.length < closestSet.points.length)
                    {
                        sets.splice(i, 0, closestSet);
                        break;
                    }
                }
            }
        };
        
        GoTracer.prototype.partition = function(sets, target)
        {
            while (sets.length > target)
            {
                var indexOfClosestSet1, indexOfClosestSet2, smallestDistance = Infinity;
                for (var i = 0; i < sets.length; i++)
                {
                    for (var j = i + 1; j < sets.length; j++)
                    {
                        var d = sets[i].getDistanceTo(sets[j]);
                        if (d < smallestDistance)
                        {
                            smallestDistance = d;
                            indexOfClosestSet1 = i;
                            indexOfClosestSet2 = j;
                        }
                    }
                }
                sets[indexOfClosestSet1].add(sets[indexOfClosestSet2]);
                sets.splice(indexOfClosestSet2, 1);
            }
        };
        
        GoTracer.prototype.assignSets = function(sets)
        {
            // Sort by lightness
            sets.sort(function(a, b) { return a.y - b.y; });
            this.blackSet = sets[0];
            
            // Sort by color
            sets.sort(function(a, b) { return a.x - b.x; });
            this.boardSet = sets[2] == this.blackSet ? sets[1] : sets[2];
            
            this.whiteSet = sets[0] == this.blackSet ? sets[1] : sets[0];
            
            this.blackSet.draw(this.ctx, "white");
            this.whiteSet.draw(this.ctx, "black");
            this.boardSet.draw(this.ctx, "brown");
        };
        
        GoTracer.prototype.getMatch = function()
        {
            return 1/3 * ( this.blackSet.getSpread() + this.whiteSet.getSpread() + this.boardSet.getSpread() );
        }
        
        GoTracer.prototype.getSGF = function()
        {
            var blackCoords = this.blackSet.points.map(function(pt) { return pt.coord; })
            var whiteCoords = this.whiteSet.points.map(function(pt) { return pt.coord; })
            //console.log (blackCoords.join(''));
            return '(;AB' + blackCoords.join('') + 'AW' + whiteCoords.join('') + ')';
            
        };
        
        
        function Point(x,y)
        {
            this.x = x;
            this.y = y;
        }
        
        Point.prototype.mix = function(that, f)
        {
            return new Point((1 - f) * this.x + f * that.x, (1 - f) * this.y + f * that.y);
        };
        
        Point.prototype.getColor = function(ctx)
        {
            try
            {
                var c = ctx.getImageData(this.x, this.y, 1, 1);
            } catch(e) { return {} }
            //  drawPixel(ctx, [0,160,0], this.x, this.y)
            var r = c.data[0];
            var g = c.data[1];
            var b = c.data[2];
            var max = Math.max(r, g, b);
            var min = Math.min(r, g, b);
            return {h: (max - min) / (max + 100) * (256 + 100), l: (r + g + b) / 3};
        }
        
        Point.prototype.draw = function(ctx, c)
        {
            if (c.constructor == Array)
            c = "rgb(" + c[0]/256*100 + "%," + c[1]/256*100 + "%," + c[2]/256*100 + "%)";
            ctx.fillStyle = c || "white";
            ctx.fillRect(this.x - 1, this.y - 1, 3, 3);
        };
        
        Point.prototype.toString = function()
        {
            return Math.round(this.x) + "," + Math.round(this.y);
        };
        
        // A * x + B * y = C
        function Line(p0, p1)
        {
            this.A = p1.y - p0.y;
            this.B = p0.x - p1.x;
            this.C = this.A * p0.x + this.B * p0.y;
            this.o = p0;
        }
        
        Line.prototype.getIntersectionWith = function(that)
        {
            var det = this.A * that.B - that.A * this.B;
            return new Point(
                             (that.B * this.C - this.B * that.C) / det,
                             (this.A * that.C - that.A * this.C) / det
                             );
        };
        
        Line.prototype.getLength = function()
        {
            if (!this.__length)
            this.__length = Math.sqrt(this.A * this.A + this.B * this.B);
            return this.__length;
        };
        
        Line.prototype.getDistanceTo = function(p)
        {
            return Math.abs(this.A * p.x + this.B * p.y - this.C) / this.getLength();
        };
        
        function Rect3D(corners)
        {
            //console.log("this.a: " + corners[0]);
            this.a = corners[0];
            this.b = corners[1];
            this.c = corners[2];
            this.d = corners[3];
            var xInf = (new Line(this.b, this.a)).getIntersectionWith(new Line(this.c, this.d));
            var yInf = (new Line(this.d, this.a)).getIntersectionWith(new Line(this.c, this.b));
            var horizon = new Line(xInf, yInf);
            this.za = 1 / horizon.getDistanceTo(this.a);
            this.zb = 1 / horizon.getDistanceTo(this.b);
            this.zc = 1 / horizon.getDistanceTo(this.c);
            this.zd = 1 / horizon.getDistanceTo(this.d);
        }
        
        Rect3D.prototype.getPoint = function(fx, fy)
        {
            var zab = this.za * (1 - fx) + this.zb * fx;
            var fab = fx * this.zb / zab;
            var zdc = this.zd * (1 - fx) + this.zc * fx;
            var fdc = fx * this.zc / zdc;
            var z = zab * (1 - fy) + zdc * fy;
            var f = fy * zdc / z;
            if (isNaN(f)) { fab = fx; fdc = fx; f = fy; }
            return this.a.mix(this.b, fab).mix(this.d.mix(this.c, fdc), f);
        };
        
        function PointSet(point)
        {
            this.points = [point];
            this.x = point.x;
            this.y = point.y;
        }
        
        PointSet.prototype.add = function(that)
        {
            var points = this.points.concat(that.points);
            this.x = (this.x * this.points.length + that.x * that.points.length) / points.length;
            this.y = (this.y * this.points.length + that.y * that.points.length) / points.length;
            this.points = points;
        };
        
        PointSet.prototype.getDistanceTo = function(that)
        {
            return Math.abs(this.x - that.x) + Math.abs(this.y - that.y);
        };
        
        PointSet.prototype.draw = function(ctx, color)
        {
            this.points.map(function(pt) { pt.p.draw(ctx, color); })
        };
        
        // PointSet.prototype.drawDebug = function(ctx, color)
        // {
        //   ctx.fillStyle = color;
        //   for (var j = 0; j < this.points.length; j++)
        //   {
        //     var p = this.points[j];
        //     ctx.fillRect(p.y / 2 - 1, p.x / 2 + 128 - 2, 2, 4);
        //   }
        // }
        
        PointSet.prototype.getSpread = function()
        {
            var total = 0;
            var thisSet = this;
            this.points.map(function(p) { total += Math.abs(thisSet.x - p.x) + Math.abs(thisSet.y - p.y); } );
            return 100 - total / this.points.length;
        }
        
        
        function drawPixel(ctx, rgb, x, y)
        {
            try
            {
                var c = ctx.getImageData(x, y, 1, 1);
                c.data[0] = rgb[0];
                c.data[1] = rgb[1];
                c.data[2] = rgb[2];
                c.data[3] = 255;
                ctx.putImageData(c, x, y);
            }
            catch(e)
            {}
        }
            
            /* -------------------- */
            /*   Preview Functions  */
            /* -------------------- */
            
            function Preview(cvs)
            {
                console.log("Preview begins");
                this.canvas = cvs;
                this.ctx = this.canvas.getContext('2d');
                this.backgroundImage = new Image();
                this.backgroundImage.src = "images/blank_board.png";
            }
            
            Preview.prototype = {
                update: function(goTracer) {
                    console.log("Preview.update");
                    this.clear();
                    this.draw(goTracer.blackSet.points, "black");
                    this.draw(goTracer.whiteSet.points, "white");
                },
                clear: function() {
                    console.log("Preview.clear");
                    this.ctx.clearRect(0,0,this.canvas.width, this.canvas.height);
                },
                draw: function(points, color) {
                    console.log("Preview.draw");
                    this.ctx.fillStyle = color == "white" ? "rgb(255,255,255)" : "rgb(0,0,0)";
                    for ( var p=0 ; p<points.length ; p++ ) {
                        this.drawStone(points[p]);
                    }
                },
                
                // point here is anything with a .x and a .y, like a PointSet
                drawStone: function(point) {
                    var x = 10 + 10.46*(point.coord[1].charCodeAt(0) - 97) -4;
                    var y = 10 + 10.46*(point.coord[2].charCodeAt(0) - 97) -4;
                    var r = 5;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, r, 0, 2*Math.PI, 0)
                    this.ctx.fill();
                    this.ctx.closePath();
                }
            };
            

            
            </script>
    </head>
    <body onload="onBodyLoad()">
        
        
        <div data-role="page" id="page1">
            <div data-role="content">                
                <div id="camerasetup">
                    <button onclick="capturePhoto();">Capture Photo</button> <br>
                    <button onclick="getPhoto(pictureSource.PHOTOLIBRARY);">From Photo Library</button><br>
                    
                    <canvas id="canvas"></canvas>
                    
                    <div id="response"></div>
                    <div id="message"></div>
                    
                </div>
            </div>
            <div data-theme="a" data-role="footer" data-position="fixed">
                <div data-role="navbar" data-iconpos="top">
                    <ul>
                        <li>
                            <a href="#page1" data-theme="" data-icon="grid" class="ui-btn-active">
                                Camera
                            </a>
                        </li>
                        <li>
                            <a href="#page2" data-theme="" data-icon="arrow-d">
                                SGF
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        
        <div data-role="page" id="page2">
            <div data-role="content">                
                <div id="sgfdisplay">
                    <div id="preview-background"></div>
                    <canvas id="preview" width="200" height="200"></canvas>
                    <a data-role="button" data-transition="slide" href="#page3">
                        Save SGF Game Record
                    </a><br />
                    <a data-role="button" data-transition="slide" href="#page4" onclick="listDir(root);">
                        Saved Games
                    </a>
                    <div id="player-container"></div>
                    <div id="sgfoutput"></div>
                    <div id="sgfmessage"></div>
                    <canvas id="sgfcanvas"></canvas>
                </div>
                
            </div>
            <div data-theme="a" data-role="footer" data-position="fixed">
                <div data-role="navbar" data-iconpos="top">
                    <ul>
                        <li>
                            <a href="#page1" data-direction="reverse" data-theme="" data-icon="grid">
                                Camera
                            </a>
                        </li>
                        <li>
                            <a href="#page2" data-theme="" data-icon="arrow-d" class="ui-btn-active">
                                SGF
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        
        <div data-role="page" id="page3">
            <div data-theme="a" data-role="header">
                <h3>
                    SGF Settings
                </h3>
                <a data-role="button" data-direction="reverse" data-transition="slide" href="#page2" data-icon="arrow-l" data-iconpos="left">
                    Cancel
                </a>
            </div>

            <div data-role="content">
                                <form id="prefsForm">
                    <!-- Need to add Rank (BR, WR), Rules (RU = Japanese, Chinese, etc) -->
                    <!-- Date (DT), location (PC), time (TM) should be added automatically? -->
                    <label for="textinput1">
                        Black:
                    </label>
                    <input id="textinput1" name="PB" placeholder="Player Name" value="" type="text" />
                    <label for="textinput2">
                        White:
                    </label>
                    <input id="textinput2" name="PW" placeholder="Player Name" value="" type="text" />
                    
                    <fieldset data-role="controlgroup" data-type="horizontal">
                        <legend>
                            Board Size:
                        </legend>
                        <input name="SZ" id="radio1" value="19" type="radio" />
                        <label for="radio1">
                            19x19
                        </label>
                        <input name="SZ" id="radio2" value="13" type="radio" />
                        <label for="radio2">
                            13x13
                        </label>
                        <input name="SZ" id="radio3" value="9" type="radio" />
                        <label for="radio3">
                            9x9
                        </label>
                    </fieldset>
                    <label for="textinput3">
                        Komi:
                    </label>
                    <input id="textinput3" name="KM" placeholder="Komi" value="5.5" type="number" />
                    <label for="textinput4">
                        Handicap:
                    </label>
                    <input id="textinput4" name="HA" placeholder="Handicap" value="0" type="number" />
                    <a href="#page2" data-role="button" data-direction="reverse" data-theme="b" data-icon="arrow-r" data-iconpos="right" onclick="savePrefs();">Save Record</a>
                   <!-- <input type="submit" data-direction="reverse" data-icon="arrow-r" data-iconpos="right" value="Submit Settings" onsubmit="savePrefs();" /> -->
                </form>
            </div>
            
        </div>
        
        
        <div data-role="page" id="page4">
            <div data-theme="a" data-role="header">
                <h3>
                    Stored Files
                </h3>
                <a data-role="button" data-direction="reverse" data-transition="slide" href="#page2" data-icon="arrow-l" data-iconpos="left">
                    Cancel
                </a>
                <a data-role="button" data-transition="fade" href="#page4" data-icon="refresh" data-iconpos="left" onclick="listDir(root);">
                    Refresh
                </a>
            </div>
            
            <div data-role="content">
                <div class="ui-grid-c" id="dirContent">
                    <div class="ui-block-a">
                        <div class="folder"><p>folder name</p></div>
                    </div>
                    <div class="ui-block-b">
                        <div class="folder"><p>folder name</p></div>
                    </div>
                    <div class="ui-block-c">
                        <div class="folder"><p>folder name</p></div>
                    </div>
                    <div class="ui-block-d">
                        <div class="folder"><p>folder name</p></div>
                    </div>
                    <!-- next row -->
                    <div class="ui-block-a">
                        <div class="file"><p>file name</p></div>
                    </div>
                    <div class="ui-block-b">
                        <div class="file"><p>file name</p></div>
                    </div>
                    <div class="ui-block-c">
                        <div class="file"><p>file name</p></div>
                    </div>
                    <div class="ui-block-d">
                        <div class="file"><p>file name</p></div>
                    </div>
                </div>
                <a id="menu" href="#menuOptions" data-rel="dialog">file details</a>
                <a id="get_file_details" href="#fileDetails" data-rel="dialog">file details</a>

            </div>                        
        </div>
        
        <div id="menuOptions" data-role="page">
            <div data-role="header">
                <h1>Select</h1>
            </div>
            <div data-role="content">
                <input type="button" id="openBtn" data-theme="e" value="Open" />
                <!-- <input type="button" id="copyBtn" value="Copy" />
                <input type="button" id="moveBtn" value="Move" />
                <input type="button" id="pasteBtn" value="Paste" disabled /> -->
                <input type="button" id="deleteBtn" value="Delete" />
            </div>
        </div>

        <div id="fileDetails" data-role="page">
            <div data-role="header">
                <h1>File</h1>
            </div>
            <div id="file_details" data-role="content"></div>
        </div>
        
        
    </body>
</html>