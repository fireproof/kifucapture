<!DOCTYPE html>
<html>
    <head>
        <title>Capture SGF</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
        <link rel="stylesheet" type="text/css" href="jquery/jquery.mobile-1.0.1.min.css" />
        
        <link rel="stylesheet" media="screen" href="style.css" type="text/css" />
        <!-- iPad/iPhone specific css below, add after your main css >
         <link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="ipad.css" type="text/css" />		
         <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="iphone.css" type="text/css" />		
         -->
        <script type="text/javascript" charset="utf-8" src="jquery/jquery-1.7.1.min.js"></script>
        <script type="text/javascript" charset="utf-8" src="jquery/jquery.mobile-1.0.1.min.js"></script>
        <script type="text/javascript" charset="utf-8" src="cordova-1.6.0.js"></script>
        <!-- plugin JS -->
        <script type="text/javascript" charset="utf-8" src="gocam-plugin.js"></script>
        <script type="text/javascript" charset="utf-8" src="Canvas2ImagePlugin.js"></script>
        <script type="text/javascript" charset="utf-8" src="ActionSheet.js"></script>
        
        <!-- EXIF plugins -->
        <!-- <script type="text/javascript" charset="utf-8" src="jquery/jquery.exif.js"></script> -->
        <script type="text/javascript" charset="utf-8" src="jquery/binaryajax.js"></script>
        <script type="text/javascript" charset="utf-8" src="jquery/imageinfo.js"></script>
        <script type="text/javascript" charset="utf-8" src="jquery/exif.js"></script>
        
        <!-- main JS -->
        <script type="text/javascript" charset="utf-8" src="Gotracer.js"></script>
        <script type="text/javascript" charset="utf-8" src="filesystem_stuff.js"></script>
        
        
        <script type="text/javascript" src="player/js/all.compressed.js"></script>
        
        <script type="text/javascript" charset="utf-8">
            
            var pictureSource;   // picture source
            var destinationType; // sets the format of returned value
            var gameState = 'newgame';
            var coords = temp.split(","); 
            var coordsCopy = coords.slice();
                        
            // File display and manipulation variables
            var root = null; // File System root variable
            var currentDir = null; // Current DirectoryEntry listed
            var parentDir = null; // Parent of the current directory
            var activeItem = null; // The clicked item
            var activeItemType = null; // d-directory, f-file
            var clipboardItem = null; // file or directory for copy or move
            var clipboardAction = null; // c-copy, m-move
            
            function preventBehavior(e) { 
                e.preventDefault(); 
            };
            
            document.addEventListener("touchmove", preventBehavior, false);
            
            function onBodyLoad() {
                document.addEventListener("deviceready", onDeviceReady, false);
            }
            
            // PhoneGap is ready to be used!
            function onDeviceReady() {
                pictureSource = navigator.camera.PictureSourceType;
                destinationType = navigator.camera.DestinationType;
                getFileSystem();
                clickItemAction();
                     
            }
            
            
            // Called when a photo is successfully retrieved
            function onPhotoURISuccess(imageURI) {
//          console.log(imageURI);
                
                var canvas = document.getElementById("canvas");
                var ctx = canvas.getContext("2d");
                
                var secondCanvas = document.getElementById("secondcanvas");
                var secondCtx = secondCanvas.getContext("2d");
                
                var image = new Image();
                
                image.onload = function(){
                                        
                    var w = image.width;
                    var h = image.height;

//                    // ------------------------------------------------------------------
//                    // making the smaller display...
//                    var smallRatio = 1;
//                    var smallMaxWidth = 300;
//                    var smallMaxHeight = 225;
//                    
//                    if ( w > smallMaxWidth) {
//                        smallRatio = smallMaxWidth / w;
//                    }
//                    else if (h > smallMaxHeight) {
//                        smallRatio = smallMaxHeight / h;
//                    }
//                    var smallNewWidth = w * smallRatio;
//                    var smallNewHeight = h * smallRatio;
//                    
//                    // First pass only!
//                    if (gameState == 'newgame') {
//                        for(i=0; i<coordsCopy.length; i++) {
//                            coordsCopy[i] = (coordsCopy[i] * smallRatio) * 1 ;
//                        }
//                    }
//                    
//                    secondCtx.canvas.width = smallNewWidth;
//                    secondCtx.canvas.height = smallNewHeight;
//                    secondCtx.drawImage(image, 0,0, smallNewWidth,smallNewHeight);
//                    
//                    goTracer = new GoTracer(image, secondCanvas);
//                    goTracer.setCorners(coordsCopy);
//                    goTracer.startScan();
//                    document.getElementById("canvas").style.display = "none";
//                    gameState = 'continue';
//                    
                    // ------------------------------------------------------------------
                    // regular size
                    var ratio = 1;
                    var maxWidth = 640;
                    var maxHeight = 480;
                                       
                    if ( w > maxWidth) {
                        ratio = maxWidth / w;
                        console.log('width greater than ' + maxWidth + ', ratio set to ' + ratio);
                    }
                    else if (h > maxHeight) {
                        ratio = maxHeight / h;
                        console.log('height greater than ' + maxHeight + ', ratio set to ' + ratio);
                    }
                    var newWidth = w * ratio;
                    var newHeight = h * ratio;
                    
                    ctx.canvas.width = newWidth;
                    ctx.canvas.height = newHeight;
                    ctx.drawImage(image, 0,0, newWidth,newHeight);
                    console.log('Original Size: ' + w + ' x ' + h + ', Resized in onPhotoURISuccess - newWidth: ' + newWidth + ' newHeight: ' + newHeight);
                    
                    // ------------------------------------------------------------------
                    // Canvas2ImagePlugin saves to Photo Library (maybe sends to Documents or temp dir instead?)
                    try {
//                        saveImage();
                        console.log("Image would be saved, but hey, let's not fill up the library right now");
                    } catch (e) {
                        console.log("can't save image - Exception: "+e);
                    }
                    
                    // ------------------------------------------------------------------
                    // a good point at which to get the corner coordinates from GoCam
                    // First pass only!
                    console.log("About to run GocamPlugin");
                    filename = imageURI.replace("file://localhost", '');
                    try {
                        GocamPlugin.nativeFunction([filename] ,
                          function(result) {
                            goTracer = new GoTracer(image, canvas);
                            goTracer.setCorners(result);
                            goTracer.startScan();
                            console.log(goTracer.getSGF());
                            
                            //document.getElementById('sgfoutput').innerHTML = goTracer.getSGF();
                            
                            // show grid over image preview on page 2, wait for "OK"
        //                    document.location.assign('#camera');
                            
                            // approve or 
                            // Update current moves in SGF file.
                            // temporary - just write all SGF to file.
                            writeFile(goTracer.getSGF());
                            
                            
                            // draw preview image in SGF page
                            /* disabling preview stuff while working on Eidogo - re-enable for error checking
                            var preview = new Preview(sgfCanvas);
                            preview.update(goTracer);
                            */
                            
        //                    document.getElementById('eidogo-player-auto').innerHTML = goTracer.getSGF();
                            
                            // reloading Eidogo needs to happen when writeFile is done
                            reloadEidogo();
                            
                            // ------------------------------------------------------------------
                            // save SGF to disk? Send via Email? Open in Browser? Display using eidogo?
                            // save in iTunes

                          },
                                                   
                          function(error) {
                            console.log("GoCam - Error : \r\n"+error);      
                          }
                        ); 
                    } catch (e) {
                        console.log("Exception: "+e);
                    }
                    
                    
                    
                };
                image.src = imageURI;
                
                // EXIF goddamnit
                // would this even give me a leg up on FIXING the EXIF orientation problem?
                // What about a jhead plugin? Argh.
                // http://blog.nihilogic.dk/2008/08/imageinfo-reading-image-metadata-with.html
                var file = imageURI;
                function getEXIF() {
                    console.log("getEXIF called for: " + file);
                    console.log(
                                "EXIF: " + ImageInfo.getField(file, "exif") + ", dimensions : " + ImageInfo.getField(file, "width") + "x" + ImageInfo.getField(file, "height")
                                );
                }
                ImageInfo.loadInfo(file, getEXIF());
                
            }
            
            
            
            
            /* -------------------------- */
            // Canvas2ImagePlugin Function
            /* -------------------------- */
            function saveImage()
            {
                var canvas2ImagePlugin = window.plugins.canvas2ImagePlugin;
                canvas2ImagePlugin.saveImageDataToLibrary(
                                                          function(msg){
                                                          console.log(msg);
                                                          }, 
                                                          function(err){
                                                          console.log(err);
                                                          }, 
                                                          'canvas'
                                                          );
            }
            
            /* ------------------- */
            /*  PhoneGap Functions */
            /* ------------------- */
            
            // A button will call this function
            
            function capturePhoto() {
                // Take picture using device camera and retrieve image as base64-encoded string
                navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 50 });
            }
            
            function capturePhotoEdit() {
                // Take picture using device camera, allow edit, and retrieve image as base64-encoded string  
                navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 20, allowEdit: true }); 
            }
            
            function getPhoto(source) {
                // Retrieve image file location from specified source
                navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 50, 
                                            destinationType: destinationType.FILE_URI,
                                            sourceType: source });
            }
            
            
                        
            
            // used instead of console.log in a few instances.
            function printObject(o) {
                var out = '';
                for (var p in o) {
                    out += p + ': ' + o[p] + '\n';
                }
                console.log(out);
            }
            
            function writeFile(SGF) {
                console.log("writeFile begins");
                window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem){
                                         console.log("writeFile root filesystem: " + fileSystem.root.name);
                                         fileSystem.root.getFile("SGF.txt", {create: true, exclusive: false}, function(fileEntry){
                                                                 console.log("writeFile - fileEntry");
                                                                 fileEntry.createWriter(function(writer){
                                                                                        writer.onwriteend = function(evt) {
                                                                                        console.log("writeFile - SGF.txt written");
                                                                                        }
                                                                                        writer.write(SGF);
                                                                                        }, onFail);
                                                                 }, onFail); 
                                         }, onFail); 
            }
            
                        
            function onFail(err) {
                console.log(err)
            }
            
            // Takes the contents of a form and turns it into a string.
            function SGFpreamble() {
                console.log("SGFpreamble begins");
                var d = new Date();
                var DTval = d.getFullYear() +"-"+ d.getMonth() +"-"+ d.getDate();
                
                var $inputs = $('#prefsForm :input');
                
                var preambleText = "(\r\n;FF[4]\r\nGM[1]\r\nAP[Moku]\r\nDT["+DTval+"]\r\n";
                $inputs.each(function() {
                             // watch out for radio buttons.
                             if (this.name == 'SZ') {
                             if ($(this).attr('checked')) {
                             preambleText += this.name + "[" + $(this).val() + "]\r\n";
                             }
                             } 
                             else {
                             preambleText += this.name + "[" + $(this).val() + "]\r\n";
                             }
                             });
                console.log(preambleText);
            }
            
            /* -------------------------- */
            //    ActionSheet Function    //
            /* -------------------------- */
            function selectAction() {
                var actionSheet = window.plugins.actionSheet;
                
                // Basic with title
                actionSheet.create('Select Image Source', ['Camera', 'Photo Library', 'Cancel'], function(buttonValue, buttonIndex) {
                                   if (arguments[1] == '0'){
                                   capturePhoto();
                                   }
                                   if (arguments[1] == '1') {
                                   getPhoto(pictureSource.PHOTOLIBRARY);
                                   }
//                                   console.log(arguments[1]);
//                                   console.warn('create(), arguments=' + Array.prototype.slice.call(arguments).join(', '));
                                   }, {cancelButtonIndex: 2});
        
            }
            
            /* -------------------------- */
            //     Eidogo SGF display     //
            /* -------------------------- */
            function reloadEidogo() {
                // set sgfUrl to "SGF.txt" for local browser testing
                // set sgfUrl to "../../Documents/SGF.txt" (saved by writeFile) for other tests
                var player = new eidogo.Player({
                                               container:       "player-container", // HTML element id indicating where to put the player
                                               theme:           "compact",          // "standard" or "compact"
                                               sgfUrl:          "../../Documents/SGF.txt", // relative URL (within same domain) to SGF file to load 
                                               loadPath:        [0, 1000],  // Location within the game tree to start. 1000 should start at last move.
                                               mode:            "play",     // "play" or "view"
                                               showComments:    false,
                                               showPlayerInfo:  false,
                                               showGameInfo:    false,
                                               showTools:       false,
                                               showOptions:     false,
                                               markCurrent:     true,
                                               markVariations:  false,
                                               markNext:        true,
                                               enableShortcuts: false,
                                               problemMode:     false
                                               });
                console.log("Eidogo reloaded");
                // how to add some HTML to this without modifying the source js?
//                $('.controls-container').append("<form id='sliderform'><label id='sliderlabel' for='slider'>Move:</label><input type='range' name='slider' id='slider' value='50' min='0' max='400' data-highlight='true' /></form>");

            }
            
            function resetNewGame() {
                gameState = 'newgame';
            }
            </script>
    </head>
    
    <body onload="onBodyLoad()">
        
        
        <div data-role="page" id="page1">
            <div data-theme="a" data-role="header">
                <h3>
                    Moku
                </h3>
                <a data-role="button" data-rel="dialog" data-transition="pop" href="#prefs" data-icon="gear" data-iconpos="notext" data-shadow="false">
                    Prefs
                </a>
                <a data-role="button" data-transition="slideup" href="#page4" onclick="listDir(root);">
                    Archives
                </a>
            </div>
            <div data-role="content">
                
                <div id="sgfdisplay">
                    <!-- disabling preview stuff while working with Eidogo -->
                    <!-- <div id="preview-background"></div>
                    <canvas id="preview" width="300" height="300"></canvas> -->
                    <div id="player-container"></div>
                    <a data-role="button" data-inline="true" data-mini="true" data-transition="flip" href="#camera" onclick="selectAction();">
                        Camera
                    </a>
                    <a data-role="button" data-inline="true" data-mini="true" data-transition="fade" href="#saveGame" data-icon="check" data-iconpos="left">
                        Save
                    </a>
                   
                    <a data-role="button" data-inline="true" data-iconpos="notext" data-transition="fade" href="#page1" data-icon="refresh" data-iconpos="left" onclick="reloadEidogo();">
                        Refresh 
                    </a>
                    <!-- eidogo-player-auto can contain SGF which *should* be displayed 
                    <div class="eidogo-player-auto"></div>-->
                    <div id="sgfoutput"></div>
                    <!-- disabling preview stuff while working on Eidogo - re-enable for error checking -->
                    <!-- <canvas id="sgfcanvas"></canvas> -->
                </div>
            </div>
        </div>
        
        
        
        <div data-role="page" id="camera">
            <div data-theme="a" data-role="header">
                <h3>
                    Camera
                </h3>
                <a data-role="button" data-direction="reverse" data-transition="flip" href="#page1" data-icon="back" data-iconpos="left">
                    Cancel
                </a>
                <!-- <a data
                    <a data-role="button" data-direction="reverse" data-transition="flip" href="#page1" data-icon="" onclick="resetNewGame(); reloadEidogo();">
                    New
                </a> -->
                <a data-role="button" data-direction="reverse" data-transition="flip" href="#page1" data-icon="" onclick="reloadEidogo();">
                    Accept
                </a>
            </div>
            <div data-role="content">
                <div id="camerasetup">
                    <canvas id="canvas"></canvas>
                    <canvas id="secondcanvas"></canvas>
                    <img id="resizedImage">
                        <div id="response"></div>
                        <div id="message"></div>
                        
                        </div>
            </div>
        </div>
        
        
        <div data-role="page" id="saveGame">
            <div data-theme="a" data-role="header">
                <h3>
                    Save Game
                </h3>
                <a data-role="button" data-direction="reverse" data-transition="fade" href="#page1" data-icon="arrow-l" data-iconpos="left">
                    Cancel
                </a>
            </div>
            
            <div data-role="content">
                <form id="prefsForm" action="#page1" method="POST">
                    <!-- Need to add Rules (RU = Japanese, Chinese, etc) -->
                    <!-- Location/Place (PC), time (TM)(ie length of game) should be added automatically? -->
                    <label for="textinput1">
                        Black:
                    </label>
                    <input id="textinput1" name="PB" placeholder="Player Name" value="" type="text" /><input id="textinputbr" name="BR" placeholder="Rank" value="" type="text" />
                    <label for="textinput2">
                        White:
                    </label>
                    <input id="textinput2" name="PW" placeholder="Player Name" value="" type="text" /><input id="textinputwr" name="WR" placeholder="Rank" value="" type="text" />
                    
                    <fieldset data-role="controlgroup" data-type="horizontal">
                        <legend>
                            Board Size:
                        </legend>
                        <input name="SZ" id="radio1" value="19" type="radio" checked="checked" />
                        <label for="radio1">
                            19x19
                        </label>
                        <input name="SZ" id="radio2" value="13" type="radio" disabled="true" />
                        <label for="radio2">
                            13x13
                        </label>
                        <input name="SZ" id="radio3" value="9" type="radio" disabled="true" />
                        <label for="radio3">
                            9x9
                        </label>
                    </fieldset>
                    <div class="formdetails">
                        <label for="textinput3">
                            Komi:
                        </label>
                        <input id="textinput3" name="KM" placeholder="Komi" value="5.5" type="number" />
                    </div>
                    <div class="formdetails">
                        <label for="textinput4">
                            Handicap:
                        </label>
                        <input id="textinput4" name="HA" placeholder="Handicap" value="0" type="number" />
                    </div>
                    <a href="#page1" data-role="button" data-direction="reverse" data-theme="b" data-icon="arrow-r" data-iconpos="right" onclick="SGFpreamble();">Save Settings</a>
                    <!-- <input type="submit" data-direction="reverse" data-icon="arrow-r" data-iconpos="right" value="Submit Settings" onsubmit="SGFpreamble();" /> -->
                </form>
            </div>
            
        </div>
        
        
        <div data-role="page" id="page4">
            <div data-theme="a" data-role="header">
                <h3>
                    Archives
                </h3>
                <a class="refreshButton" data-role="button" data-iconpos="notext" data-transition="fade" href="#page4" data-icon="refresh" data-iconpos="left" onclick="listDir(root);">
                    Refresh
                </a>
                <a data-role="button" data-transition="slidedown" href="#page1" data-icon="arrow-l" data-iconpos="left">
                    Back
                </a>
            </div>
            
            <div data-role="content">
                <div class="ui-grid-c" id="dirContent">
                    <div class="ui-block-a">
                        <div class="folder"><p>folder name</p></div>
                    </div>
                    <div class="ui-block-b">
                        <div class="folder"><p>folder name</p></div>
                    </div>
                    <div class="ui-block-c">
                        <div class="folder"><p>folder name</p></div>
                    </div>
                    <div class="ui-block-d">
                        <div class="folder"><p>folder name</p></div>
                    </div>
                    <!-- next row -->
                    <div class="ui-block-a">
                        <div class="file"><p>file name</p></div>
                    </div>
                    <div class="ui-block-b">
                        <div class="file"><p>file name</p></div>
                    </div>
                    <div class="ui-block-c">
                        <div class="file"><p>file name</p></div>
                    </div>
                    <div class="ui-block-d">
                        <div class="file"><p>file name</p></div>
                    </div>
                </div>
                <a id="menu" href="#menuOptions" data-rel="dialog">file details</a>
                <a id="get_file_details" href="#fileDetails" data-rel="dialog">file details</a>
                
            </div>                        
        </div>
        
        <div id="menuOptions" data-role="page">
            <div data-role="header">
                <h1>Select</h1>
            </div>
            <div data-role="content">
                <input type="button" id="openBtn" data-theme="e" value="Details" />
                <!-- <input type="button" id="copyBtn" value="Copy" />
                 <input type="button" id="moveBtn" value="Move" />
                 <input type="button" id="pasteBtn" value="Paste" disabled /> -->
                <input type="button" id="deleteBtn" value="Delete" />
            </div>
        </div>
        
        <div id="fileDetails" data-role="page">
            <div data-role="header">
                <h1>File</h1>
            </div>
            <div id="file_details" data-role="content"></div>
        </div>
        
        <div id="prefs" data-role="page">
            <div data-role="header">
                <h1>Preferences</h1>
                <!-- <a data-role="button" data-direction="reverse" data-transition="fade" href="#page1" data-icon="arrow-l" data-iconpos="left">
                    Back
                </a> -->
                
            </div>
            <div id="file_details" data-role="content">
            
            </div>
        </div>
    </body>
</html>
